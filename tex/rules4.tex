\documentclass[11pt]{article}
\usepackage{fullpage}
\usepackage{latexsym}
\usepackage{verbatim}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{stackengine}
\usepackage{scalerel}
\usepackage{code,proof,amsthm,amssymb, amsmath}
\usepackage{proof}
\usepackage{mathpartir}
\usepackage{turnstile}

\input{generic-defns}
\input{syn-defns}
\input{../pfpl/fun-defns}
\input{../pfpl/pcf-defns}
\input{../pfpl/prod-defns}
\input{../pfpl/sum-defns}
\input{../pfpl/icoi-defns}
\input{../pfpl/t-defns}

% =========================================================================== %
%                                                                             %
%                          Using this LaTeX Template                          %
%                                                                             %
% - new tasks are on their own section (how Gradescope expects them)          %
% - use '\task' to start a new task                                           %
% - use 'begin{task} ... \end{task}' if you'd like to preface your answer     %
%   with the question itself (i.e., fill in the '...' with the question)      %
% - use '\nextgroup' to advance from, for example, Task 1.4 to Task 2.1       %
% - use '\skipaheadtask' to skip from, for example, Task 2.2 to Task 2.4      %
%                                                                             %
% You also have access to all the definitions from the handout. See defs.tex, %
% syn-defns.tex, and generic-defns.tex.                                       %
%                                                                             %
%               TODO: Fill in your personal information below!                %
%                                                                             %
% =========================================================================== %
\newcommand{\myname}{Andrew Carnegie}
\newcommand{\myandrewid}{andrew}
\newcommand{\hwnumber}{1}
% =========================================================================== %

\newcounter{group}
\setcounter{group}{1}
\newtheorem{theorem}{Task}[group]
% Remove '\newpage' below to preview your doc compactly.
% Remember to put it back before submitting to Gradescope.
\newcommand{\task}{\newpage\begin{theorem}\end{theorem}}
\newcommand{\nextgroup}{\stepcounter{group}}
\newcommand{\skipaheadtask}{\stepcounter{theorem}}
\newcommand{\ms}[1]{\ensuremath{\mathsf{#1}}}
\newcommand{\irl}[1]{\mathtt{#1}}
\newcounter{rule}
\setcounter{rule}{0}
\newcommand{\rn}
  {\addtocounter{rule}{1}(\arabic{rule})}

\newcounter{infercount}
\setcounter{infercount}{1}
\newcommand{\infern}[2]{\inferrule{#1}{#2}(\text{S}_{\arabic{infercount}}\stepcounter{infercount})}
\newcommand*\ts[2]{%
  \,\scalebox{1}[0.5]{$\sststile[ss]{\textstyle#1}{\textstyle#2}$}\,
}
\newcommand{\inferr}[2]{\inferrule{#2}{#1}}
\newcommand{\paircaseabt}[4]{\irl{case}(#2,#3.#4)}
\newcommand{\paircasecst}[4]{\irl{case} \; #1\; \{(#2;#3) \hookrightarrow #4\}}

\title{15-312 Assignment \hwnumber}
\author{\myname\\(\myandrewid)}
\date{\today}

\begin{document}
\maketitle

\[
\begin{array}{r l l l l}
\ms{Type} & \tau \,\,\,\,\, ::= \\
	& \irl{nat}                	 			& \irl{nat}											& \text{naturals}\\
	& \unittyabt                	 			& \unittycst										& \text{unit}\\
  & \booltyabt                       & \booltycst                    & \text{boolean}\\
  & \prodtyabt{\tau_1}{\tau_2}       & \prodtycst{\tau_1}{\tau_2}    & \text{product}\\
	&\irl{arr}(\tau_1;\tau_2) 				& \arrtycst{\tau_1}{\tau_2} 									& \text{function}\\
  &\listtyabt{\tau}		& \listtycst{\tau}											& \text{list}\\
	 \\
\ms{Exp}
        & e   \,\,\,\,\, ::= \\
 	& x                                			& x 												& \text{variable}\\
  & \irl{nat}[n]							& \numeral{n}												& \text{number}\\
  & \irl{unit}							& ()												& \text{unit}\\
  & \irl{T}							& \irl{T}												& \text{true}\\
  & \irl{F}	   					& \irl{F}												& \text{false}\\
  & \ifexabt{x}{e_1}{e_2} & \ifexcst{x}{e_1}{e_2}  & \text{if}\\
  & \irl{lam}(x:\tau.e) 						&\lambda \; x : \tau. e 		& \text{abstraction}\\
  & \irl{ap}(f;x) 					& \appcst{f}{x} 										& \text{application}\\
  & \irl{tpl}(x_1;x_2)     	& \pairexcst{x_1}{x_2}                									& \text{pair}\\
 	& \paircaseabt{p}{x_1}{x_2}{e_1}					& \paircasecst{p}{x_1}{x_2}{e_1}   	& \text{match pair}\\
 	& \nilexabt					& []   										& \text{nil}\\
 	& \consexabt{x_1}{x_2}					& x_1::x_2   										& \text{cons}\\
 	& \listcaseexabt{l}{e_1}{x}{xs}{e_2}					& \listcaseexcst{l}{e_1}{x}{xs}{e_2}   	& \text{match list}\\
  & \irl{let}(e_1; x : \tau.e_2)			& \irl{let}\; x = e_1 \; \irl{in}\; e_2   	& \text{let}\\
  \\
\ms{Val}
        & v   \,\,\,\,\, ::= \\
 	& \irl{val}(n)                                			& n 												& \text{numeric value}\\
 	& \irl{val}(\irl{T})                               			& \irl{T} 								  & \text{true value}\\
 	& \irl{val}(\irl{F})                                			& \irl{F}								  & \text{false value}\\
 	& \irl{val}(\irl{Null})                                  & \irl{Null} 								  & \text{null value}\\
 	& \irl{val}(\irl{cl}(V; x.e))                & (V, x.e) 					& \text{function value}\\
 	& \irl{val}(l)                                			& l 								  & \text{loc value}\\
 	& \irl{val}(\pairexabt{v_1}{v_2})                             & \pairexcst{v_1}{v_2} 								  & \text{pair value}\\
  \\
\ms{Loc}
        & l   \,\,\,\,\, ::= \\
 	& \irl{loc}(l)                                			& l 												& \text{location}\\
\end{array}
\]

\section{Garbage collection semantics}

Model dynamics using judgement of the form:
\[
\fbox{$V,H,R,F \; \vdash e \Downarrow v, H', F'$}
\]

Where $V : VID \to Val$, $H : Loc \to Val$, and $R : \{Loc\}$. This can be read as: under stack $V$, heap $H$, roots $R$,
freelist $F$, the expression $e$ evaluates to $v$, and engenders a new heap $H'$ and freelist $F'$.\\

Roots represents the set of locations required to compute the continuation \emph{excluding} the current expression.
We can think of roots as the heap allocations necessary to compute the context with a hole that will be filled
by the current expression.\\

Below defines the size of reachable values and space for roots:

\begin{align*}
  &reach_{H}((V, x.e)) = \bigcup\limits_{y \in FV(e) \setminus x} reach_H(V(y)) \\
  &reach_{H}(l) = \{l\} \cup reach_{H}(H(l))\\
  &reach_{H}(\pairexcst{v_1}{v_2}) = reach_{H}(v_1) \cup reach_{H}(v_2)\\
  &reach_{H}(\_) = \emptyset\\\\
  &locs_{V,H}(e) = \bigcup\limits_{x \in FV(e)} reach_H(V(x))
\end{align*}

\begin{mathpar}

\infern
{ x \in dom(V)
}
{V,H,R,F \; \vdash x \Downarrow V(x),H,F}

\infern
{
}{
  V,H,R,F \; \vdash \numeral{n} \Downarrow \irl{val}(n),H,F
}

\infern{
}{
  V,H,R,F \; \vdash \irl{T} \Downarrow \irl{val(T)},H,F
}

\infern{
}{
  V,H,R,F \; \vdash \irl{F} \Downarrow \irl{val(F)},H ,F
}

\infern{
}{
  V,H,R,F \; \vdash () \Downarrow \irl{val(Null)},H ,F
}

\infern{
  V(x) = \irl{T}\\
  g = \{l \in H | l \notin F \cup R \cup locs_{V,H}(e_1)\}\\
  V,H,R,F \cup g\; \vdash e_1 \Downarrow v, H',F'
}{
  V,H,R,F \; \vdash \ifexabt{x}{e_1}{e_2} \Downarrow v, H',F'
}

\infern{
  V(x) = \irl{F}\\
  g = \{l \in H | l \notin F \cup R \cup locs_{V,H}(e_2)\}\\
  V,H,R,F \cup g \; \vdash e_2 \Downarrow v, H',F'
}{
  V,H,R,F \; \vdash \ifexabt{x}{e_1}{e_2} \Downarrow v, H' ,F'
}

% function

\infern{
  l \in F\\
  F' = F \setminus \{l\}\\
  H' = H[l \mapsto (V,x.e)]
}{
  V,H,R,F \; \vdash \irl{lam}(x : \tau.e) \Downarrow l,H' ,F'
}

\infern{
  V(f) = (V_1, x.e) \\
  V(x) = v_1 \\
  V_1[x \mapsto v_1], H, R \; \vdash e \Downarrow v, H',F'
}{
  V,H,R,F \; \vdash \appcst{f}{x} \Downarrow v,H',F'
}

% tuples

\infern{
  V(x_1) = v_1 \\
  V(x_2) = v_2 \\
}{
  V,H,R,F \; \vdash \pairexcst{x_1}{x_2} \Downarrow \pairexcst{v_1}{v_2},H ,F
}

\infern{
  V(x) = \pairexcst{v_1}{v_2}\\
  g = \{l \in H | l \notin F \cup R \cup locs_{V,H}(e)\}\\
  V[x_1 \mapsto v_1, x_2 \mapsto v_2],H,R,F \cup g \; \vdash e \Downarrow v,H',F'
}{
  V,H,R,F \; \vdash \paircasecst{x}{x_1}{x_2}{e} \Downarrow v, H' ,F'
}

% lists

\infern{
}{
  V,H,R,F \; \vdash \nilexabt \Downarrow \irl{val(Null)},H,F
}

\infern{
  V(x_1) = v_1\\
  V(x_2) = v_2\\
  l \in F\\
  F' = F \setminus \{l\}\\
  H' = H[l \mapsto \pairexcst{v_1}{v_2}]
}{
  V,H,R,F \; \vdash \consexcst{x_1}{x_2} \Downarrow l,H' ,F'
}

\infern{
  V(z) = \irl{Null}\\
  g = \{l \in H | l \notin F \cup R \cup locs_{V,H}(e_1)\}\\
  V,H,R,F \cup g \; \vdash e_1 \Downarrow v, H',F' \\
}{
  V,H,R,F \; \vdash \listcaseexcst{z}{e_1}{x_h}{x_t}{e_2} \Downarrow v,H',F'
}

\infern{
  V(z) = \pairexcst{v_h}{v_t} \\
  g = \{l \in H | l \notin F \cup R \cup locs_{V,H}(e_2)\}\\
  V[x_h \mapsto v_h, x_t \mapsto v_t],H,R,F \cup g \; \vdash e_2 \Downarrow v, H',F' \\
}{
  V,H,R,F \; \vdash \listcaseexcst{z}{e_1}{x_h}{x_t}{e_2} \Downarrow v,H',F'
}

\infern{
  R' = R \cup locs_{V,H}(\irl{lam}(x : \tau.e_2))\\
  V,H,R',F \vdash e_1 \Downarrow v_1,H_1,F_1\\
  V' = V[x \mapsto v_1]\\
  R'' = R \cup locs_{V',H_1}(e_2)\\
  g = \{ l \in H_1 | l \notin R'' \cup F_1 \}\\
  V',H_1,R, F_1 \cup g \vdash e_2 \Downarrow v_2,H_2,F_2 \\
}{
  V,H,R,F \; \vdash \irl{let}(e_1; x : \tau.e_2) \Downarrow v_2,H_2,F_2
}
\end{mathpar}

\section{Type rules}

The type system takes into account of garbaged collected cells by returning potential locally in a match construct. Since we are interested in the number of heap cells, all constants are assumed to be nonnegative.

\begin{mathpar}
\inferr{
  \Sigma; \emptyset \sststile{q}{q} n : \irl{nat}
}{
  n \in \mathbb{Z}
}(\text{L:ConstI})

\inferr{
  \Sigma; \emptyset \sststile{q}{q} () : \irl{unit}
}{
}(\text{L:ConstU})

\inferr{
  \Sigma; \emptyset \sststile{q}{q} \irl{T} : \irl{bool}
}{
}(\text{L:ConstT})

\inferr{
  \Sigma; \emptyset \sststile{q}{q} \irl{F} : \irl{bool}
}{
}(\text{L:ConstF})

\inferr{
  \Sigma; x : B \sststile{q}{q} x : B
}{
}(\text{L:Var})

\inferr{
  \Sigma; \Gamma, x : \irl{bool} \sststile{q'}{q} \ifexcst{x}{e_t}{e_f} : B
}{
  \Sigma; \Gamma \sststile{q'}{q} e_t : B &
  \Sigma; \Gamma \sststile{q'}{q} e_f : B
}(\text{L:Cond})

\inferr{
  \Sigma; x_1 : A_1, x_2 : A_2 \sststile{q}{q} \pairexcst{x_1}{x_2} : (A_1,A_2)
}{
}(\text{L:Pair})

\inferr{
  \Sigma; \Gamma, x : (A_1,A_2) \sststile{q'}{q} \paircasecst{x}{x_1}{x_2}{e} : B
}{
  \Sigma; \Gamma, x_1 : A_1, x_2 : A_2 \sststile{q'}{q} e : B
}(\text{L:MatP})

\inferr{
  \Sigma; \emptyset \sststile{q}{q} \irl{nil} : L^p(A)
}{
}(\text{L:Nil})

\inferr{
  \Sigma; \Gamma, x_h : A, x_t : L^p(A) \sststile{q}{q+p+K^{cons}} \consexcst{x_h}{x_t} : L^p(A)
}{
}(\text{L:Cons})

\inferr{
  \Sigma; \Gamma, x : L^p(A) \sststile{q'}{q} \listcaseexcst{z}{e_1}{x}{xs}{e_2} : B
}{
  \Sigma; \Gamma \sststile{q'}{q} e_1 : B &
  \Sigma; \Gamma, x_h : A, x_t : L^p(A) \sststile{q'}{q + p + 1} e_2 : B
}(\text{L:MatL})

\inferr{
  \Sigma; \Gamma_1, \Gamma_2 \sststile{q'}{q} \irl{let}(e_1; x : \tau.e_2) : B
}{
  \Sigma; \Gamma_1 \sststile{p}{q} e_1 : A &
  \Sigma; \Gamma_2, x : A \sststile{q'}{p} e_2 : B
}(\text{L:Let})
\end{mathpar}

\section{Soundness for heap allocation}

We simplify the soundness proof of the type system for the general metric to one with monotonic resource.
(No function types for now)

\begin{theorem}[Soundness]
\label{a} let $H \vDash V : \Gamma$ and $\Sigma; \Gamma \sststile{q'}{q} e : B$
If $  V,H,R,F \; \vdash e \Downarrow v, H', F'$, then 
\begin{align}
%   |F|  &\le \Phi_{V,H}(\Gamma) +q\\
  |F| - |F'| &\le \Phi_{V,H}(\Gamma) +q - (\Phi_{H'}(v:B) + q')
\end{align}
\end{theorem}

\begin{proof}
Induction on the evaluation judgement.\\
\begin{description}
  \item[Case 1: E:Var]
  \begin{align}
  &V,H,R,F \; \vdash x \Downarrow V(x),H,F \tag{admissibility}\\
  &\Sigma; x : B \sststile{q}{q} x : B \tag{admissibility}\\
  &|F| - |F'|\\
  &\quad = |F| - |F| \tag{ad.}\\
  &\quad = 0\\
  &\Phi_{V,H}(\Gamma) + q - (\Phi_{H'}(v:B) + q')\\
  &\quad = \Phi_{V,H}(x : B) + q - (\Phi_{H}(V(x) : B) + q) \tag{ad.}\\
  &\quad = \Phi_{H}(V(x) : B) + q  - (\Phi_{H}(V(x) : B) + q) \tag{def. of $\Phi_{V,H}$}\\
  &\quad = 0\\
  &|F| - |F'| \le \Phi_{V,H}(\Gamma) +q - (\Phi_{H'}(v:B) + q') \tag{(3),(5)}
  \end{align}
  \item[Case 2: E:Const*]
  Due to similarity, we show only for E:ConstI
  \begin{align*}
  &|F| - |F'| = |F| - |F| \tag{ad.}\\
  &\quad = 0\\
  &\Phi_{V,H}(\Gamma) +q - (\Phi_{H'}(v:B) + q') = \Phi_{V,H}(\emptyset) +q - (\Phi_{H}(v:int) + q) \tag{ad.}\\
  &\quad = 0 \tag{def of $\Phi_{V,H}$}\\
  &|F| - |F'| \le \Phi_{V,H}(\Gamma) +q - (\Phi_{H'}(v:B) + q')
  \end{align*}
  \item[Case 4: E:App]
  \item[Case 5: E:CondT]
  \begin{align*}
  &\Gamma = \Gamma', x : \irl{bool} \tag{ad.}\\
  &H \vDash V : \Gamma' \tag{def of W.F.E}\\
  &\Sigma; \Gamma' \sststile{q'}{q} e_t : B \tag{ad.}\\
  &V,H,R,F \cup g\; \vdash e_t \Downarrow v, H',F' \tag{ad.}\\
  &|F \cup g| - |F'| \le \Phi_{V,H}(\Gamma) +q - (\Phi_{H'}(v:B) + q') \tag{IH}\\
  &|F| - |F'| \le \Phi_{V,H}(\Gamma) +q - (\Phi_{H'}(v:B) + q') \\
  \end{align*}
  \item[Case 6: E:CondF] 
  Similar to E:CondT
  \item[Case 7: E:Let]
  \begin{align*}
  &V,H,R',F \vdash e_1 \Downarrow v_1,H_1,F_1 \tag{ad.}\\
  &\Sigma; \Gamma_1 \sststile{p}{q} e_1 : A \tag{ad.}\\
  &H \vDash V : \Gamma_1 \tag{$\Gamma_1 \subseteq \Gamma$}\\
  &|F| - |F_1| \le \Phi_{V,H}(\Gamma_1) +q - (\Phi_{H_1}(v_1:A) + p) \tag{IH}\\
  &V',H_1,R, F_1 \cup g \vdash e_2 \Downarrow v_2,H_2,F_2 \tag{ad.}\\
  &\Sigma; \Gamma_2, x : A \sststile{q'}{p} e_2 : B \tag{ad.}\\
  &H_1 \vDash v_1 : A \text{ and } \tag{Theorem 3.3.4}\\ 
  &H_1 \vDash V : \Gamma_2 \tag{???}\\
  &H_1 \vDash V' : \Gamma_2, x : A \tag{def of $\vDash$}\\
  &|F_1 \cup g| - |F_2| \le  \Phi_{V',H_1}(\Gamma_2, x:A) +p - (\Phi_{H_2}(v_2:B) + q') \tag{IH}\\
  &|F_1| - |F_2| \le \Phi_{V',H_1}(\Gamma_2,x:A) + p - (\Phi_{H_2}(v_2:B) + q')\\
  &\text{summing the inequalities:}\\
  &|F| - |F_1| + |F_1| - |F_2| \le \Phi_{V,H}(\Gamma_1) +q - (\Phi_{H_1}(v_1:A) + p) + \Phi_{V',H_1}(\Gamma_2,x:A) + p - (\Phi_{H_2}(v_2:B) + q')\\
  &|F| - |F_2| \le \Phi_{V,H}(\Gamma_1) +q - \Phi_{H_1}(v_1:A) + \Phi_{V',H_1}(\Gamma_2,x:A) - (\Phi_{H_2}(v_2:B) + q')\\
  &\quad = \Phi_{V,H}(\Gamma_1) + \Phi_{V',H_1}(\Gamma_2) + q - \Phi_{H_1}(v_1:A) + \Phi_{V',H_1}(x:A) - (\Phi_{H_2}(v_2:B) + q') \tag{def of $\Phi_{V,H}$}\\
  &\quad = \Phi_{V,H}(\Gamma_1) + \Phi_{V,H}(\Gamma_2) + q - \Phi_{H_1}(v_1:A) + \Phi_{V',H_1}(x:A) - (\Phi_{H_2}(v_2:B) + q') \tag{Lemma 4.3.3}\\
  &\quad = \Phi_{V,H}(\Gamma) + q - \Phi_{H_1}(v_1:A) + \Phi_{H_1}(v_1:A) - (\Phi_{H_2}(v_2:B) + q') \tag{def of $\Phi_{V,H}$}\\
  &\quad = \Phi_{V,H}(\Gamma) + q - (\Phi_{H_2}(v_2:B) + q') \\
  \end{align*}
  \item[Case 8: E:Pair]
  \item[Case 9: E:MatP]
  \item[Case 10: E:Nil]
  \item[Case 11: E:Cons]
  \item[Case 12: E:MatNil]
  \item[Case 13: E:MatCons]
  \begin{align*}
  &V(z) = \pairexcst{v_h}{v_t}^L \tag{ad.}\\
  &\Gamma = \Gamma', x : L^p(A) \tag{ad.}\\
  &\Sigma; \Gamma', x_h : A, x_t : L^p(A) \sststile{q'}{q + p + K^{cons}} e_2 : B \tag{ad.}\\
  &\text{let } V' = V[x_h \mapsto v_h, x_t \mapsto v_t]\\
  &V',H,R,F \cup g \; \vdash e_2 \Downarrow v_2, H_2, F' \tag{ad.} \\
  &H \vDash V' : \Gamma', x_h : A, x_t : L^p(A) \tag{Lemma*}\\
  &|F \cup g| - |F'| \le  \Phi_{V,H}(\Gamma',x_h:A,x_t:L^p(A)) + q + p + K^{cons} - (\Phi_{H'}(v:B) + q') \tag{IH}\\
  &\quad = \Phi_{V,H}(\Gamma') + \Phi_H(v_h:A) + \Phi_H(v_t:L^p(A)) + p + q + 1 - (\Phi_{H'}(v:B) + q') \tag{def of $\Phi_{V,H}$}\\
  &\quad = \Phi_{V,H}(\Gamma') + \Phi_H(\pairexcst{v_h}{v_t}^L : L^p(A)) + q + 1 - (\Phi_{H'}(v:B) + q') \tag{Lemma 4.1.1}\\
  &\quad = \Phi_{V,H}(\Gamma', z : L^p(A)) + q + 1 - (\Phi_{H'}(v:B) + q') \tag{def of $\Phi_{V,H}$}\\
  &\quad = \Phi_{V,H}(\Gamma) + q + 1 - (\Phi_{H'}(v:B) + q') \tag{Lemma 4.1.1}\\
  &\text{Looking at $z$, we have: }\\
  &locs_{V,H}(z) \nsubseteq R \cup locs_{V,H}(e_2) \tag{Heap linearity}\\
  &\text{Then,}\\
  &locs_{V,H}(z) \subseteq g \tag{def of $g$}\\
  &\text{Furthermore,}\\
  &|locs_{V,H}(z)| \ge 1 \tag{def of $locs_{V,H}$}\\
  &|g| \ge 1 \tag{$locs_{V,H} \subseteq g$}\\
  &|F \cup g| - |F'|\\
  &\quad = |F| + |g| - |F'| \tag{$F,g$ disjoint}\\
  &\text{Hence,}\\
  &|F| + |g| - |F'| \le  \Phi_{V,H}(\Gamma) + q + 1 - (\Phi_{H'}(v:B) + q')\\
  &|F| - |F'| \le \Phi_{V,H}(\Gamma) + q + 1 - |g| - (\Phi_{H'}(v:B) + q')\\
  &\quad \le \Phi_{V,H}(\Gamma) + q - (\Phi_{H'}(v:B) + q') \tag{$|g| \ge 1$}\\
  \end{align*}
\end{proof}


\end{document}
