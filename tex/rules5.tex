\documentclass[11pt]{article}
\usepackage{fullpage}
\usepackage{latexsym}
\usepackage{verbatim}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{stackengine}
\usepackage{scalerel}
\usepackage{code,proof,amsthm,amssymb, amsmath}
\usepackage{proof}
\usepackage{mathpartir}
\usepackage{turnstile}
\usepackage{fancyvrb}
\usepackage{stmaryrd}
\usepackage{mathtools}
\usepackage{hyperref}
\usepackage[margin=0.5in]{geometry}

\allowdisplaybreaks

\input{generic-defns}
\input{syn-defns}
\input{../pfpl/fun-defns}
\input{../pfpl/pcf-defns}
\input{../pfpl/prod-defns}
\input{../pfpl/sum-defns}
\input{../pfpl/icoi-defns}
\input{../pfpl/t-defns}

% =========================================================================== %
%                                                                             %
%                          Using this LaTeX Template                          %
%                                                                             %
% - new tasks are on their own section (how Gradescope expects them)          %
% - use '\task' to start a new task                                           %
% - use 'begin{task} ... \end{task}' if you'd like to preface your answer     %
%   with the question itself (i.e., fill in the '...' with the question)      %
% - use '\nextgroup' to advance from, for example, Task 1.4 to Task 2.1       %
% - use '\skipaheadtask' to skip from, for example, Task 2.2 to Task 2.4      %
%                                                                             %
% You also have access to all the definitions from the handout. See defs.tex, %
% syn-defns.tex, and generic-defns.tex.                                       %
%                                                                             %
%               TODO: Fill in your personal information below!                %
%                                                                             %
% =========================================================================== %
\newcommand{\myname}{Andrew Carnegie}
\newcommand{\myandrewid}{andrew}
\newcommand{\hwnumber}{1}
% =========================================================================== %

\newcounter{group}
\setcounter{group}{1}
\newtheorem{theorem}{Task}[group]
% Remove '\newpage' below to preview your doc compactly.
% Remember to put it back before submitting to Gradescope.
\newcommand{\task}{\newpage\begin{theorem}\end{theorem}}
\newcommand{\nextgroup}{\stepcounter{group}}
\newcommand{\skipaheadtask}{\stepcounter{theorem}}
\newcommand{\ms}[1]{\ensuremath{\mathsf{#1}}}
\newcommand{\irl}[1]{\mathtt{#1}}
\newcounter{rule}
\setcounter{rule}{0}
\newcommand{\rn}
  {\addtocounter{rule}{1}(\arabic{rule})}	

\newcounter{infercount}
\setcounter{infercount}{1}
\newcommand{\infern}[2]{\inferrule{#1}{#2}(\text{S}_{\arabic{infercount}}\stepcounter{infercount})}
\newcommand*\ts[2]{%
  \,\scalebox{1}[0.5]{$\sststile[ss]{\textstyle#1}{\textstyle#2}$}\,
}
\newcommand{\inferr}[2]{\inferrule{#2}{#1}}
\newcommand{\inferrr}[3]{\inferrule[#1]{#2}{#3}}
\newcommand{\paircaseabt}[4]{\irl{case}(#2,#3.#4)}
\newcommand{\paircasecst}[4]{\irl{case} \; #1\; \{(#2;#3) \hookrightarrow #4\}}
\newcommand{\na}[1]{\mathsf{no\_alias}(#1)}
\newcommand{\nr}[1]{\mathsf{no\_ref}(#1)}
\newcommand{\stable}[1]{\mathsf{stable}(#1)}
\newcommand{\set}[1]{\mathsf{set}(#1)}
\newcommand{\safe}[1]{\mathsf{safe}(#1)}
\newcommand{\dist}[1]{\mathsf{disjoint}(#1)}
\newcommand{\stack}[1]{\irl{stack}(#1)}
\newcommand{\denote}[1]{\llbracket#1\rrbracket}
\newcommand{\nil}{[]}
\newcommand{\cons}[2]{\pi(#1,#2)}
\newcommand{\sharecst}[4]{\irl{share}\;#1\;\irl{as}\;#2,#3\;\irl{in}\;#4}
\newcommand{\shareabt}[4]{\irl{share}(#1;#2,#3.#4)}
\newcommand{\ssize}[2]{\left\Vert #2 \right\Vert_{#1}}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}{Corollary}[theorem]

\title{15-312 Assignment \hwnumber}
\author{\myname\\(\myandrewid)}
\date{\today}
\setlength{\parindent}{0pt}

\begin{document}
\maketitle
\pagenumbering{gobble}

\section{Introduction}

\noindent
In this paper, we propose a model for deriving asymptotically tight bounds for first order functional programs. We choose a fragment of OCaml as the target language. The abstract and concrete syntax of the language is show below. Note that we only allow first order functions of type $\tau_1 \to \tau_2$, where $\tau_1$ and $\tau_2$ are base types: unit, bool, product, or lists. 

\[
\begin{array}{r l l l l}
\ms{BTypes} & \tau \,\,\,\,\, ::= \\
	& \irl{nat}                	 			& \irl{nat}											& \text{naturals}\\
	& \unittyabt                	 			& \unittycst										& \text{unit}\\
  & \booltyabt                       & \booltycst                    & \text{boolean}\\
  & \prodtyabt{\tau_1}{\tau_2}       & \prodtycst{\tau_1}{\tau_2}    & \text{product}\\
  &\listtyabt{\tau}		& L(\tau)											& \text{list}\\
  \\
\ms{FTypes} & \rho \,\,\,\,\, ::= \\
	&\irl{arr}(\tau_1;\tau_2) 				& \arrtycst{\tau_1}{\tau_2} 									& \text{first order function}\\
	 \\
\ms{Exp}
        & e   \,\,\,\,\, ::= \\
 	& x                                			& x 												& \text{variable}\\
  & \irl{nat}[n]							& \numeral{n}												& \text{number}\\
  & \irl{unit}							& ()												& \text{unit}\\
  & \irl{T}							& \irl{T}												& \text{true}\\
  & \irl{F}	   					& \irl{F}												& \text{false}\\
  & \ifexabt{x}{e_1}{e_2} & \ifexcst{x}{e_1}{e_2}  & \text{if}\\
  & \irl{lam}(x:\tau.e) 						&\lambda \; x : \tau. e 		& \text{abstraction}\\
  & \irl{ap}(f;x) 					& \appcst{f}{x} 										& \text{application}\\
  & \irl{tpl}(x_1;x_2)     	& \pairexcst{x_1}{x_2}                									& \text{pair}\\
 	& \paircaseabt{p}{x_1}{x_2}{e_1}					& \paircasecst{p}{x_1}{x_2}{e_1}   	& \text{match pair}\\
 	& \nilexabt					& []   										& \text{nil}\\
 	& \consexabt{x_1}{x_2}					& x_1::x_2   										& \text{cons}\\
 	& \listcaseexabt{l}{e_1}{x}{xs}{e_2}					& \listcaseexcst{l}{e_1}{x}{xs}{e_2}   	& \text{match list}\\
  & \irl{let}(e_1; x : \tau.e_2)			& \irl{let}\; x = e_1 \; \irl{in}\; e_2   	& \text{let}\\
  & \shareabt{x}{x_1}{x_2}{e} &\sharecst{x}{x_1}{x_2}{e} &\text{share}\\
  \\
\ms{Val}
        & v   \,\,\,\,\, ::= \\
 	& \irl{val}(n)                                			& n 												& \text{numeric value}\\
 	& \irl{val}(\irl{T})                               			& \irl{T} 								  & \text{true value}\\
 	& \irl{val}(\irl{F})                                			& \irl{F}								  & \text{false value}\\
 	& \irl{val}(\irl{Null})                                  & \irl{Null} 								  & \text{null value}\\
 	& \irl{val}(\irl{cl}(V; x.e))                & (V, x.e) 					& \text{function value}\\
 	& \irl{val}(l)                                			& l 								  & \text{loc value}\\
 	& \irl{val}(\pairexabt{v_1}{v_2})                             & \pairexcst{v_1}{v_2} 								  & \text{pair value}\\
  \\
\ms{State} & s   \,\,\,\,\, ::= \\
 	& \irl{alive}                                			& \irl{alive} 												& \text{live value}\\
 	& \irl{dead}                                			& \irl{dead} 												& \text{dead value}\\\\
\ms{Loc} & l   \,\,\,\,\, ::= \\
 	& \irl{loc}(l)                                			& l 												& \text{location}\\\\
\ms{Var} & l   \,\,\,\,\, ::= \\
 	& \irl{var}(x)                                			& x 												& \text{variable}\\
\end{array}
\]

\newpage
\section{Paths and aliasing}

Model dynamics using judgement of the form:
\[
\fbox{$V,H,R,F \; \vdash_{P : \Sigma} e \Downarrow v, H', F'$}
\]

\noindent
Where $V : \ms{Var} \to \ms{Val} \times \ms{State}$, $H : \ms{Loc} \to \ms{Val}$, $R \subseteq \ms{Loc}$, $F \subseteq \ms{Loc}$, and $\Sigma : \ms{Var} \to \ms{FTypes}$. This can be read as: under stack $V$, heap $H$, roots $R$,
freelist $F$, and program $P$ with signature $\Sigma$, the expression $e$ evaluates to $v$, and engenders a new heap $H'$ and freelist $F'$.\\

\noindent
A \emph{program} is then a $\Sigma$ indexed map $P$ from $\ms{Var}$ to pairs $(y_f,e_f)_{f \in \Sigma}$, where $\Sigma(y_f) = A \to B$, and $\Sigma;y_f : A \vdash e_f : B$ (typing rules are discussed in $\ref{sec:typing}$). We write $P : \Sigma$ to mean $P$ is a program with signature $\Sigma$. Because the signature $\Sigma$ for the mapping of function names to first order functions does not change during evaluation, we drop the subscript $\Sigma$ from $\vdash_{\Sigma}$ when the context of evaluation is clear. It is convenient to think of the evaluation judgement $\vdash$ as being indexed by a family of signatures $\Sigma$'s, each of which is a set of ``top-level'' first-order declarations to be used during evaluation.\\

\noindent 
For a partial map $f : A \to B$, we write $dom$ for the defined values of $f$. Sometimes we shorten $x \in dom(f)$ to $x \in f$. We write $f[x \mapsto y]$ for the extension of $f$ where $x$ is mapped to $y$, with the constraint that $x \notin dom(f)$. \\

\noindent
Roots represents the set of locations required to compute the continuation \emph{excluding} the current expression.
We can think of roots as the heap allocations necessary to compute the context with a hole that will be filled
by the current expression.\\

\noindent
In order prove soundness of the type system, we need some auxiliary judgements to defining properties of a heap. Below we define $reach : Val \to \{\{\ms{Loc}\}\}$ that maps stack values its the root \emph{multiset}, the multiset of locations that's already on the stack. 

\noindent
Next we define reachability of values:

\begin{align*}
&reach_H(\pairexcst{v_1}{v_2}) = reach_H(v_1) \uplus reach_H(v_2)\\
&reach_H(l) = \{l\} \uplus reach_H(H(l))\\
&reach_H(\_) = \emptyset
\end{align*}
For a multiset $S$, we write $\mu_S : S \to \mathbb{N}$ for the multiplicity function of $S$, which maps each element to the count of its occurence. If $\mu_S(x) \ge 1$ for a multiset $S$, then we write $x \in S$ as in the usual set membership relation. If for all  $s \in S$, $\mu(s) = 1$, then $S$ is a property set, and we denote it by $\ms{set}(S)$. Addtionally, $A \uplus B$ denotes counting union of sets where $\mu_{A \uplus B} (s) = \mu_A (s) + \mu_B (s)$, and $A \cup B$ denotes the usual union where $\mu_{A \cup B}(s) = \max{(\mu_A(s),\mu_B(s))}$. For the disjoint union of sets $A$ and $B$, we write $A \sqcup B$.\\

\noindent
Next, we define the predicates $\ms{no\_alias}$, $\ms{stable}$, and $\ms{disjoint}$:
\begin{description}
% \item [$\ms{forest}(H)$: ]\\
% $\forall l,l_1,l_2 \in H$, if $H \vDash p : l_1 \leadsto l$ and $H \vDash q : l_2 \leadsto l$, then $l_1 = l_2$ and $H \vDash p \equiv q : l_1 \leadsto l$.
\item[$\na{V,H}$: ] \\
$\forall x,y \in V$, $x \ne y$. \text{ Let } $r_x = reach_H(V(x))$, $r_y = reach_H(V(y))$. Then:
\begin{enumerate}
\item $\ms{set}(r_x), \ms{set}(r_y)$
\item $r_x \cap r_y = \emptyset$
\end{enumerate}
\item[$\ms{stable}(R,H,H')$: ] $\forall l \in R$. $H(l) = H'(l)$.
\item [$\ms{safe}(V,H,F)$: ] $\forall x \in V$. $reach_{H}(V(x)) \cap F = \emptyset$
\item[$\dist{\mathcal{C}}$: ] $\forall X,Y \in \mathcal{C}$. $X \cap Y = \emptyset$ 
\end{description}

For a stack $V$ and a heap $H$, whenever $\na{V,H}$ holds, visually, one can think of the situation as the following: the induced graph of heap $H$ with variables on the stack as additional leaf nodes is a forest: a disjoint union of arborescences (directed trees); consequently, there is at most one path from a live variable on the stack $V$ to a location in $H$ by following the pointers.\\

First, we define $FV^{\star}(e)$, the multiset of free variables of $e$. As the usual $FV$, it is defined inductively over the structure of $e$; the only unusual thing is that multiple occurences of a free variable $x$ in $e$ will be reflected in the multiplicity of $FV^{\star}(e)$.\\

Next, we define $locs_{V,H}$ using the previous notion of reachability. 
\begin{equation*}
  &locs_{V,H}(e) = \bigcup\limits_{x \in FV(e)} reach_H(V(x))\\\\
\end{equation*}

$size$ calculates the \emph{literal size} of a value, e.g. the size to store its address.
\begin{align*}
  &size(\pairexcst{v_1}{v_2}) = size(v_1) + size(v_2)\\
  &size(\_) = 1
\end{align*}

$\ssize{H}{\cdot}$ calculates the \emph{semantic} or \emph{heap size} of a value, e.g. the size of the heap structure induced by the value.
\begin{align*}
  &\ssize{H}{\pairexcst{v_1}{v_2}} = \ssize{H}{v_1} + \ssize{H}{v_2}\\
  &\ssize{H}{l} = 1 + \ssize{H}{H(l)}\\
\end{align*}

As usual, we extend it to stacks $V$: $\ssize{H}{V} = \sum_{V(x) = v} \ssize{H}{v}$\\

$copy(H,L,v)$ takes a heap $H$, a set of locations $L$, and a value $v$, and returns a new heap $H'$ and a location $l$ such that $l$ maps to $v$ in $H'$.
\begin{align*}
  &copy(H,L,\pairexcst{v_1}{v_2}) =\\
  &\quad\mathsf{let }\; L_1 \sqcup L_2 \subseteq L\\
  &\quad\quad\mathsf{ where }\; |L_1| = size(v_1) \;,|L_2| = size(v_2)\\
  &\quad\mathsf{let }\; H_1 = copy(H,L_1,v_1) \\
  &\quad\mathsf{let }\; H_2 = copy(H_1,L_2,v_2) \;\mathsf{in}\\
  &\quad H_2\{l \mapsto v\}\\
  &copy(H,L,v) =\\
  &\quad\mathsf{let }\; l \in H\; \mathsf{in}\\
  &\quad H\{l \mapsto v\}\\
\end{align*}

\section{Garbage collection semantics}

\begin{mathpar}

\infern
{ V(x) = v\\
}
{V,H,R,F \; \vdash x \Downarrow v,H,F}

\infern
{
}{
  V,H,R,F \; \vdash \numeral{n} \Downarrow \irl{val}(n),H,F
}

\infern{
}{
  V,H,R,F \; \vdash \irl{T} \Downarrow \irl{val(T)},H,F
}

\infern{
}{
  V,H,R,F \; \vdash \irl{F} \Downarrow \irl{val(F)},H ,F
}

\infern{
}{
  V,H,R,F \; \vdash () \Downarrow \irl{val(Null)},H ,F
}

\infern{
  V = V'[x \mapsto \irl{T}]\\
  g = \{l \in H \mid l \notin F \cup R \cup locs_{V,H}(e_1)\}\\
  V',H,R,F \cup g\; \vdash e_1 \Downarrow v, H',F'
}{
  V,H,R,F \; \vdash \ifexabt{x}{e_1}{e_2} \Downarrow v, H',F'
}

\infern{
  V = V'[x \mapsto \irl{F}]\\
  g = \{l \in H \mid l \notin F \cup R \cup locs_{V,H}(e_2)\}\\
  V',H,R,F \cup g \; \vdash e_2 \Downarrow v, H',F'
}{
  V,H,R,F \; \vdash \ifexabt{x}{e_1}{e_2} \Downarrow v, H' ,F'
}

% function

\infern{
  V(x) = v'\\
  P(f) = (y_f,e_f)\\
  g = \{l \in H \mid l \notin F \cup R \cup locs_{V,H}(e_f)\}\\
  [y_f \mapsto v'],H,R,F \cup g \; \vdash e_f \Downarrow v,H',F'\\
}{
  V,H,R,F \; \vdash \appcst{f}{x} \Downarrow v,H',F'
}

% tuples

\infern{
  V(x_1) = v_1 \\
  V(x_2) = v_2 \\
}{
  V,H,R,F \; \vdash \pairexcst{x_1}{x_2} \Downarrow \pairexcst{v_1}{v_2},H ,F
}

\infern{
  V = V'[x \mapsto \pairexcst{v_1}{v_2}]\\
  g = \{l \in H \mid l \notin F \cup R \cup locs_{V,H}(e)\}\\
  V'' = V'[x_1 \mapsto v_1, x_2 \mapsto v_2]\\
  V'',H,R,F \cup g \; \vdash e \Downarrow v,H',F'
}{
  V,H,R,F \; \vdash \paircasecst{x}{x_1}{x_2}{e} \Downarrow v, H' ,F'
}

% lists

\infern{
}{
  V,H,R,F \; \vdash \nilexabt \Downarrow \irl{val(Null)},H,F
} 

\infern{
  V = V'[x \mapsto v']\\
  g = reach_H(v')\\
  V',H,R,F \cup g \; \vdash e \Downarrow v,H',F'
}{
  V,H,R,F \; \vdash \irl{drop}(x;e) \Downarrow v,H',F'
}

\infern{
  V = V'[x \mapsto v']\\
  V'[x_1 \mapsto v',x_2 \mapsto v'],H,R,F \; \vdash e \Downarrow v,H',F'
}{
  V,H,R,F \; \vdash \sharecst{x}{x_1}{x_2}{e} \Downarrow v,H',F'
}

\infern{
  v = \pairexcst{V(x_1)}{V(x_2)}\\
  L \sqcup \{l\}\subseteq F\\
  |L| = size_H(v)\\
  F' = F \setminus (L \sqcup \{l\})\\
  H' = copy(H,L,v)\\
  H'' = H'\{l \mapsto v\}
}{
  V,H,R,F \; \vdash \consexcst{x_1}{x_2} \Downarrow l,H'' ,F'
}

\infern{
  V(x) = \irl{Null}\\
  V' \subseteq V\\
  dom(V') = FV(e_1)\\
  g = \{l \in H \mid l \notin F \cup R \cup locs_{V,H}(e_1)\}\\
  V',H,R,F \cup g \; \vdash e_1 \Downarrow v, H',F' \\
}{
  V,H,R,F \; \vdash \listcaseexcst{x}{e_1}{x_h}{x_t}{e_2} \Downarrow v,H',F'
}

\infern{
  V(x) =  l\\
  H(l) = \pairexcst{v_h}{v_t} \\
  V' \subseteq V\\
  dom(V') = FV(e_2) \setminus \{x_h,x_t\} \\
  V'' = V'[x_h \mapsto v_h, x_t \mapsto v_t]\\
  g = \{l \in H \mid l \notin F \cup R \cup locs_{V'',H}(e_2)\}\\
  V'',H,R,F \cup g \; \vdash e_2 \Downarrow v, H',F' \\
}{
  V,H,R,F \; \vdash \listcaseexcst{x}{e_1}{x_h}{x_t}{e_2} \Downarrow v,H',F'
}

\infern{
  V = V_1 \sqcup V_2\\
  dom(V_1) = FV(e_1)\\
  dom(V_2) = FV(\irl{lam}(x : \tau. e_2))\\
  R' = R \cup locs_{V_2,H}(\irl{lam}(x : \tau.e_2))\\
  V_1,H,R',F \vdash e_1 \Downarrow v_1,H_1,F_1\\
  V_2' = V_2[x \mapsto v_1]\\
  g = \{ l \in H_1 \mid l \notin F_1 \cup R \cup locs_{V_2',H_1}(e_2) \}\\
  V_2',H_1,R, F_1 \cup g \vdash e_2 \Downarrow v_2,H_2,F_2 \\
}{
  V,H,R,F \; \vdash \irl{let}(e_1; x : \tau.e_2) \Downarrow v_2,H_2,F_2
}


\end{mathpar}
\section{Operational semantics}
In order to prove the soundess of the type system, we also define a simplified operational semantics that does not account for garbage collection. 

\[
\fbox{$V,H \vdash e \Downarrow v, H'$}
\]

This can be read as: under stack $V$, heap $H$ the expression $e$ evaluates to $v$, and engenders a new heap $H'$. We write the representative rules.

\begin{mathpar}
\infern{
  v = \pairexcst{V(x_1)}{V(x_2)}\\
  (L \sqcup \{l\}) \cap dom(H) = \emptyset\\
  H',l = copy(H,L,v)\\
}{
  V,H \; \vdash \consexcst{x_1}{x_2} \Downarrow l,H'
}

\infern{
  V(x) = l \\
  H(l) = \pairexcst{v_h}{v_t} \\
  V' \subseteq V\\
  dom(V') = FV(e_2) \setminus \{x_h,x_t\}\\
  V'' = V'[x_h \mapsto v_h, x_t \mapsto v_t]\\
  V'',H \; \vdash e_2 \Downarrow v, H' \\
}{
  V,H \; \vdash \listcaseexcst{x}{e_1}{x_h}{x_t}{e_2} \Downarrow v,H'
}

\infern{
  V = V_1 \sqcup V_2\\
  dom(V_1) = FV(e_1)\\
  dom(V_2) = FV(\irl{lam}(x : \tau. e_2))\\
  V_1,H \vdash e_1 \Downarrow v_1,H_1\\
  V_2' = V_2[x \mapsto v_1]\\
  V_2',H_1\vdash e_2 \Downarrow v_2,H_2\\
}{
  V,H \; \vdash \irl{let}(e_1; x : \tau.e_2) \Downarrow v_2,H_2
}
\end{mathpar}
\section{Well Defined Environments}
In order to define the potential for first-order types, we need a notion of well-define environments, one that relates 
heap values to semantic values of a type. We first give a denotational semantics for the first-order types: 

\begin{align*}
() &\in \denote{\unittyabt}\\
\bot &\in \denote{\booltyabt}\\
\top &\in \denote{\booltyabt}\\
0 &\in \denote{\irl{nat}}\\
n + 1 &\in \denote{\irl{nat}} \text{ if } n \in \denote{\irl{nat}}\\
\nil &\in \denote{L(A)}\\
\cons{a}{l} &\in \denote{L(A)} \text{ if } a \in \denote{A} \text{ and } l \in \denote{L(A)}\\
\end{align*}

Where semantic set for each type is the least set such that the above holds. Note $\pi(x,y)$ is the usual set-theoretic pairing function, and write $[a_1,...,a_n]$ for $\pi(a_1,...,\pi(a_n,[]))$. \\

Now we give the judgements relating heap values to semantic values, in the form \fbox{$H \vDash v \mapsto a : A$}, which can be read as: under heap $H$, heap value $v$ defines the semantic value $a \in \denote{A}$.  

\begin{mathpar}
\inferr{
  H \vDash \val{n} \mapsto n : \irl{nat}
}{
  n \in \mathbb{Z}
}(\text{V:ConstI})

\inferr{
  H \vDash \val{\irl{Null}} \mapsto n : \unittyabt
}{
}(\text{V:ConstI})

\inferr{
  H \vDash \val{\irl{Null}} \mapsto n : L(A)
}{
  A \in \ms{BType}
}(\text{V:Nil})

\inferr{
  H \vDash \val{\irl{T}} \mapsto \top : \booltyabt
}{
}(\text{V:True})

\inferr{
  H \vDash \val{\irl{F}} \mapsto \bot : \booltyabt
}{
}(\text{V:False})

\inferr{
  H \vDash l \mapsto [a_1,\ldots,a_n] : L(A)
}{
  l \in \ms{Loc}\\
  H(l) = \pairexcst{v_h}{v_t}\\
  H \vDash v_h \mapsto a_1 : A\\
  H \vDash v_t \mapsto [a_2,\ldots,a_n] : L(A)
}(\text{V:Cons})
\end{mathpar}
\section{Stack vs Heap Allocated Types}
In order to share variables, we need to distinguish between types that are allocated on the stack and the heap. 
We write \fbox{$\stack{A}$} to denote that values of type $A$ will be allocataed \emph{entirely} on the stack at run time (no references into the heap). 

\begin{mathpar}
\inferr{
  \stack{A}
}
{
  A \in \{\unittyabt,\booltyabt,\irl{nat}\}
}(\text{S:Const})

\inferr{
  \stack{\prodtycst{A_1}{A_2}}
}
{
  \stack{A_1} \\
  \stack{A_2}
}(\text{S:Product})
\end{mathpar}

\section{Linear Garbage Collection Type Rules}
\label{sec:typing}

The linear version of the type system takes into account of garbaged collected cells by returning potential locally in a match construct. Since we are interested in the number of heap cells, all constants are assumed to be nonnegative. The second let rule expresses the fact that since stack types don't reference heap cells, any heap cells used in the evaluation of $e_1$ can be deallocated, as there are no longer references to them in $v_1$. 

\begin{mathpar}
\inferr{
  \Sigma; \emptyset \sststile{q}{q} n : \irl{nat}
}{
  n \in \mathbb{Z}
}(\text{L:ConstI})

\inferr{
  \Sigma; \emptyset \sststile{q}{q} () : \irl{unit}
}{
}(\text{L:ConstU})

\inferr{
  \Sigma; \emptyset \sststile{q}{q} \irl{T} : \irl{bool}
}{
}(\text{L:ConstT})

\inferr{
  \Sigma; \emptyset \sststile{q}{q} \irl{F} : \irl{bool}
}{
}(\text{L:ConstF})

\inferr{
  \Sigma; x : B \sststile{q}{q} x : B
}{
}(\text{L:Var})

\inferr{
  \Sigma; x : A \sststile{q'}{q} f(x) : B
}
{
  \Sigma(f) = A \xmapsto{q/q'} B
}

\inferr{
  \Sigma; \Gamma, x : \irl{bool} \sststile{q'}{q} \ifexcst{x}{e_t}{e_f} : B
}{
  \Sigma; \Gamma \sststile{q'}{q} e_t : B \\
  \Sigma; \Gamma \sststile{q'}{q} e_f : B
}(\text{L:Cond})

\inferr{
  \Sigma; x_1 : A_1, x_2 : A_2 \sststile{q}{q} \pairexcst{x_1}{x_2} : \prodtycst{A_1}{A_2}
}{
}(\text{L:Pair})

\inferr{
  \Sigma; \Gamma, x : (A_1,A_2) \sststile{q'}{q} \paircasecst{x}{x_1}{x_2}{e} : B
}{
  \Sigma; \Gamma, x_1 : A_1, x_2 : A_2 \sststile{q'}{q} e : B
}(\text{L:MatP})

\inferr{
  \Sigma; \emptyset \sststile{q}{q} \irl{nil} : L^p(A)
}{
}(\text{L:Nil})

\inferr{
  \Sigma; x_h : A, x_t : L^p(A) \sststile{q}{q+p+1} \consexcst{x_h}{x_t} : L^p(A)
}{
}(\text{L:Cons})

\inferr{
  \Sigma; \Gamma, x : L^p(A) \sststile{q'}{q} \listcaseexcst{x}{e_1}{x_h}{x_t}{e_2} : B
}{
  \Sigma; \Gamma \sststile{q'}{q} e_1 : B \\
  \Sigma; \Gamma, x_h : A, x_t : L^p(A) \sststile{q'}{q + p + 1} e_2 : B
}(\text{L:MatL})

\inferr{
  \Sigma; \Gamma_1, \Gamma_2 \sststile{q'}{q} \irl{let}(e_1; x : \tau.e_2) : B
}{
  \Sigma; \Gamma_1 \sststile{p}{q} e_1 : A \\
  \Sigma; \Gamma_2, x : A \sststile{q'}{p} e_2 : B
}(\text{L:Let})

\inferr{
  \Sigma; \Gamma_1, \Gamma_2 \sststile{q'}{q} \irl{let}(e_1; x : \tau.e_2) : B
}{
  \Sigma; \Gamma_1 \sststile{p}{q} e_1 : A \\
  \stack{A}\\
  \Sigma; \Gamma_2, x : A \sststile{q'}{\max{(p,q)}} e_2 : B
}(\text{L:LetS})

\inferr{
  \Sigma; \Gamma, x : A \sststile{q'}{q} \irl{drop}(x;e) : B
}{
  \Sigma; \Gamma \sststile{q'}{q} e : B
}(\text{L:Drop})

\inferr{
  \Sigma; \Gamma, x : A \sststile{q'}{q} \sharecst{x}{x_1}{x_2}{e} : B
}{
  \stack{A}\\
  \Sigma; \Gamma, x_1 : A, x_2 : A \sststile{q'}{q} e : B
}(\text{L:Share})
\end{mathpar}

Now if we take $\dagger :  L^p(A) \mapsto L(A)$ as the map that erases resource annotations, 
 we obtain a simpler typing judgement \fbox{$\Sigma^{\dagger}; \Gamma^{\dagger} \vdash e : B^{\dagger}$}.
 
\section{Type Rules For Sharing}

\begin{align*}
L^p(A) - n &= L ^ {\max{(p - n,0)}}(A - n)\\
\prodtycst{A_1}{A_2} - n &= \prodtycst{A_1 - n}{A_2 - n}\\
A - n &= A\\
\end{align*}

\begin{mathpar}
\inferr{
  \Sigma; \Gamma, x : A \sststile{q'}{q} \sharecst{x}{x_1}{x_2}{e} : B
}{
  A \;\ms{ with } \;A_1, A_2\\
  \Sigma; \Gamma, x_1 : A_1, x_2 : A_2 \sststile{q'}{q} e : B
}(\text{M:Share})

\inferr{
  \Sigma; \Gamma_1, \Gamma_2 \sststile{q'}{q} \irl{let}(e_1; x : \tau.e_2) : B
}{
  \Sigma; \Gamma_1 \sststile{p}{q} e_1 : A \\
  \Sigma; \Gamma_1 \sststile{}{\ms{cf}} e_1 : A' \\
  \Sigma; \Gamma_2, x : (A' - 1) \sststile{q'}{p} e_2 : B
}(\text{M:Let})
\end{mathpar}

\newpage
\section{Soundness for Linear GC}

We simplify the soundness proof of the type system for the general metric to one with monotonic resource.
(No function types for now)

\begin{lemma}
\label{a} If $\Sigma; \Gamma \sststile{q'}{q} e : B$, then $\Sigma^{\dagger}; \Gamma^{\dagger} \vdash e : B^{\dagger}$.
\end{lemma}

\begin{lemma}\label{itm:linear}
\label{a} If $\Sigma; \Gamma \sststile{q'}{q} e : B$, then $\set{FV^{\star}(e)}$ and $dom(\Gamma) = FV(e)$.
\end{lemma}

\begin{proof}
Induction on the typing judgement.
\end{proof}

\begin{lemma}\label{itm:stable}
Let $H \vDash v \mapsto a : A$. For all sets of locations $R$, if $reach_H(v) \subseteq R$ and $\stable{R,H,H'}$, then $H' \vDash v \mapsto a : A$ and $reach_H(v) = reach_{H'}(v)$.
\end{lemma}

\begin{proof}
Induction on the structure of $v$.
\end{proof}

\begin{corollary}
Let $H \vDash V : \Gamma$. For all sets of locations $R$, if $\bigcup_{x \in V} reach_H(V(x)) \subseteq R$ and $\stable{R,H,H'}$, then $H' \vDash V : \Gamma$.
\end{corollary}

\begin{proof}
Follows from Lemma $\ref{itm:stable}$.
\end{proof}

\begin{lemma}\label{itm:stack}
Let $H \vDash v \mapsto a : A$. If $\stack{A}$, then $\Phi_H(v:A) = 0$.
\end{lemma}

\begin{proof}
Induction on $H \vDash v \mapsto a : A$.
\end{proof}

% heap conservation
\begin{lemma}[heap conservation]
Let $V,H,R,F \; \vdash e \Downarrow v, H', F'$, and $g = \gc{H'}{R}{F'}$. 
Then $\ssize{H}{V} + |F| = \ssize{H'}{v} + |F' \cup g|$.
\end{lemma}

% main lemma

\begin{lemma}[main lemma]\label{itm:na}
For all stacks $V$ and heaps $H$, let  $V,H,R,F \; \vdash e \Downarrow v, H', F'$ and $\Sigma; \Gamma \vdash e : B$. Then given the following: 
\begin{enumerate}
\item $dom(V) = FV(e)$
\item $\na{V,H}$, and
\item $\dist{\{R,F,locs_{V,H}(e)\}}$
\end{enumerate} 
We have the follwoing: 
\begin{enumerate}
\item $\ms{set}(reach_{H'}(v))$
\item $\dist{\{R,F',reach_{H'}(v)\}}$, and
\item $\stable{R,H,H'}$
\end{enumerate}
\end{lemma}

\begin{proof}
Nested induction on the evaluation judgement and the typing judgement.\\
\begin{description}
  \item[Case 1: E:Var]
  \begin{align*}
  &\text{Suppose } H \vDash V : \Gamma, dom(V) = FV(e), \na{V,H}, \dist{\{R,F,locs_{V,H}(e)\}}\\
  &\ms{set}(reach_{H}(v)) \tag{$\na{V,H}$}\\
  &\dist{\{R,F,reach_{H}(v)\}} \tag{$\dist{\{R,F,locs_{V,H}(e)\}}$}\\
  &\na{V,H} \tag{Sp.}\\
  &\stable{R,H,H'} \tag{$H = H'$}
  \end{align*}
  \item[Case 2: E:Const*]
  Due to similarity, we show only for E:ConstI
  \begin{align*}
  &\text{Suppose } H \vDash V : \Gamma, dom(V) = FV(e), \na{V,H},\dist{\{R,F,locs_{V,H}(e)\}}\\
  &\ms{set}(reaach_{H}(v)) \tag{$reach_H(v) = \emptyset$}\\
  &\dist{\{R,F,\emptyset\}} \tag{$\dist{R,F}$}\\
  &\na{V,H} \tag{Sp.}\\
  &\stable{R,H,H'} \tag{$H = H'$}
  \end{align*}
  \item[Case 4: E:App]
  \item[Case 5: E:CondT] Similar to E:MatNil
  \item[Case 6: E:CondF] Similar to E:CondT
  \item [Case 7: E:Let]
  \begin{align*}
  &V,H,R,F \; \vdash \irl{let}(e_1; x : \tau.e_2) \Downarrow v_2,H_2,F_2 \tag{case}\\
  &V,H,R',F \vdash e_1 \Downarrow v_1,H_1,F_1 \tag{ad.}\\
  &\Sigma; \Gamma_1,\Gamma_2 \vdash \irl{let}(e_1; x : \tau.e_2) : B \tag{case}\\
  &\Sigma; \Gamma_1 \vdash e_1 : A \tag{ad.}\\
  &\text{Suppose } H \vDash V : \Gamma, dom(V) = FV(e), \na{V,H}, \dist{\{R,F,locs_{V,H}(e)\}}\\ 
  &H \vDash V_1 : \Gamma_1 \tag{def of W.D.E and Lemma $~\ref{itm:linear}$}\\
  &\text{By IH, we have invariant on } J_1\\
  &\text{NTS (1) - (3) to instantiate invariant on } J_1\\
  &\emph{(1)}\quad dom(V_1) = FV(e_1) \tag{def of $V_1$}\\
  &\emph{(2)}\quad \na{V_1,H} \tag{$\na{V,H}$ and $V_1 \subseteq V$}\\
  &\emph{(3)}\quad \dist{R',F,locs_{V,H}(e_1)}\\
  &F \cap R' = \emptyset \tag{$F \cap locs_{V,H}(e) = \emptyset$ and $locs_{V_2,H}(\irl{lam}(x : \tau. e_2)) \subseteq locs_{V,H}(e)$}\\
  &FV(e_1) \cap FV(\irl{lam}(x : \tau. e_2)) = \emptyset \tag{Lemma ~\ref{itm:linear}}\\
  &locs_{V,H}(e_1) \cap locs_{V_2,H}(\irl{lam}(x : \tau. e_2)) = \emptyset \tag{$\na{V,H}$}\\
  &R' \cap locs_{V,H}(e_1) = \emptyset \tag{$\dist{\{R,locs_{V,H}(e)\}}$}\\
  &F \cap locs_{V,H}(e_1) = \emptyset \tag{Sp.}\\
  &\text{Thus we have } \dist{R',F,locs_{V,H}(e_1)}\\
  &\text{By IH, }\\
  &\emph{(1)}\quad \ms{set}(reach_{H_1}(v_1))\\
  &\emph{(2)}\quad \dist{\{R',F_1,reach_{H_1}(v_1)\}}\\
  &\emph{(3)}\quad \stable{R',H,H_1}\\
  &V_2',H_1,R, F_1 \cup g \vdash e_2 \Downarrow v_2,H_2,F_2 \tag{ad.} \\
  &\Sigma; \Gamma_2, x : A \vdash e_2 : B \tag{ad.}\\
  &H_1 \vDash V_2' : (\Gamma_2, x : A) \tag{???}\\
  &\text{By IH, we have invariant on } J_2\\
  &\text{NTS (1) - (3) to instantiate invariant on } J_2\\
  &\emph{(1)}\quad dom(V_2') = FV(e_2) \tag{def of $V_2'$}\\
  &\emph{(2)}\quad \na{V_2',H_1}\\
  &\text{Let } x_1, x_2 \in V2', x_1 \ne x_2 \text{ be arb.}\\
  &\textbf{case: } x_1 \ne x, x_2 \ne x\\
  &\quad reach_H(V_2'(x_1)) \subseteq R' \tag{$reach_H(V_2'(x_1)) \subseteq locs_{V_2',H}(\irl{lam}(x : \tau. e_2))$}\\
  &\quad reach_H(V_2'(x_2)) \subseteq R' \tag{$reach_H(V_2'(x_2)) \subseteq locs_{V_2',H}(\irl{lam}(x : \tau. e_2))$}\\
  &\quad reach_H(V_2'(x_1)) = reach_{H_1}(V_2'(x_1)),reach_H(V_2'(x_2)) = reach_{H_1}(V_2'(x_2)) \tag{$\stable{R',H,H_1}$ and Lemma $~\ref{itm:stable}$}\\
  &\quad reach_{H_1}(V_2'(x_1)) = reach_{H}(V(x_1)),reach_{H_1}(V_2'(x_2)) = reach_{H}(V(x_2)) \tag{$\stable{R',H,H_1}$ and Lemma $~\ref{itm:stable}$}\\
  &\quad \na{V_2',H_1} \tag{$\na{V,H}$}\\
  &\textbf{case: } x_1 = x, x_2 \ne x\\
  &\quad reach_{H_1}(V_2'(x_1)) = reach_{H_1}(v_1) \tag{def of $V_2'$}\\
  &\quad reach_{H_1}(V_2'(x_2)) \subseteq R' \tag{same as above}\\
  &\quad \ms{set}(reach_{H_1}(v_1)) \tag{IH 1.1}\\
  &\quad reach_{H_1}(V_2'(x_2)) = reach_{H}(V(x_2)) \tag{same as above}\\
  &\quad \ms{set}(reach_{H_1}(V_2'(x_2))) \tag{$\na{V,H}$}\\
  &\quad reach_{H_1}(V_2'(x_1)) \cap reach_{H_1}(V_2'(x_2)) = \emptyset \tag{$\dist{\{R',reach_{H_1}(v_1)\}}$}\\
  &\text{Thus we have } \na{V_2',H_1}\\
  &\emph{(3)}\quad \dist{\{R,F_1 \cup g,locs_{V_2',H_1}(e_2)\}}\\
  &R \cap F_1 = \emptyset \tag{$\dist{\{R', F_1\}}$ from 1.2 and $R \subseteq R'$}\\
  &R \cap (F_1 \cup g) = \emptyset \tag{def of $g$}\\
  &\text{NTS } (F_1 \cup g) \cap locs_{V_2',H_1}(e_2) = \emptyset\\
  &\text{Let } l \in locs_{V_2',H_1}(e_2) \text{ be arb.}\\
  &l \in reach_{H_1}(V_2'(x')) \text{ for some } x' \in V_2'\\
  &\textbf{case: } x' \ne x\\
  &\quad reach_H(V_2(x')) = reach_{H_1}(V_2'(x')) \tag{same as above}\\
  &\quad reach_{H_1}(V_2'(x')) \subseteq R' \tag{def of $R'$}\\
  &\quad reach_{H_1}(V_2'(x')) \cap F_1 = \emptyset \tag{$\dist{\{R', F_1\}}$ from 1.2}\\
  &\text{case: } x' = x\\
  &\quad reach_{H_1}(V_2'(x')) = reach_{H_1}(v_1) \tag{def of $V_2'$}\\
  &\quad reach_{H_1}(V_2'(x')) \cap F_1 = \emptyset \tag{$\dist{\{F_1,reach_{H_1}(v_1)\}}$ from 1.2}\\
  &reach_{H_1}(V_2'(x')) \subseteq locs_{V_2',H_1}(e_2) \tag{def of $locs_{V,H}$}\\
  &reach_{H_1}(V_2'(x')) \cap g = \emptyset \tag{def of $g$}\\
  &\text{Thus } reach_{H_1}(V_2'(x')) \cap (F_1 \cup g) = \emptyset\\
  &\text{NTS } R \cap locs_{V_2',H_1}(e_2) = \emptyset\\
  &\text{Let } l \in locs_{V_2',H_1}(e_2) \text{ be arb.}\\
  &l \in reach_{H_1}(V_2'(x')) \text{ for some } x' \in V_2'\\
  &\textbf{case: } x' \ne x\\
  &\quad reach_H(V_2(x')) = reach_{H_1}(V_2'(x')) \tag{same as above}\\
  &\quad l \in locs_{V,H}(e) \tag{def of $locs_{V,H}$}\\
  &\quad l \notin R \tag{$\dist{\{R,locs_{V,H}(e)\}}$ from 0.3}\\
  &\textbf{case: } x' = x\\
  &\quad reach_{H_1}(V_2'(x')) = reach_{H_1}(v_1) \tag{def of $V_2'$}\\
  &\quad reach_{H_1}(V_2'(x')) \cap R = \emptyset \tag{$\dist{\{R', reach_{H_1}(v_1)\}}$ from 1.2 and $R \subseteq R'$}\\
  &\text{Thus } reach_{H_1}(V_2'(x')) \cap R = \emptyset\\
  &\text{Hence we have }\emph{(3)}\quad \dist{R,F_1 \cup g,locs_{V_2',H_1}(e_2)}\\
  &\text{By instantiating the invariant on } J_2, \text{ we have }\\
  &\emph{(1)}\quad \ms{set}(reach_{H_2}(v_2))\\
  &\emph{(2)}\quad \dist{\{R,F_2,reach_{H_2}(v_2)\}}\\
  &\emph{(3)}\quad \stable{R,H_1,H_2}\\
  &\text{Lastly, showing (1) - (3) holds for the original case } J_0:\\
  &\emph{(1)}\quad \ms{set}(reach_{H_2}(v_2)) \tag{By 2.1}\\
  &\emph{(2)}\quad \dist{\{R,F_2,reach_{H_2}(v_2)\}} \tag{By 2.2}\\
  &\emph{(3)}\quad \stable{R,H_1,H_2}\\
  &\text{Let } l \in R \text{ be arb. }\\
  &H(l) = H_1(l) \tag{$\stable{R',H,H_1}$ from 1.3}\\
  &H_1(l) = H_2(l) \tag{$\stable{R,H_1,H_2}$ from 2.3}\\
  &H(l) = H_2(l)\\
  &\text{Hence } \stable{R,H,H_2}\\
  \end{align*}
  \item[Case 8: E:Pair]
  Similar to E:Var
  \item[Case 9: E:MatP]
  Similar to E:MatCons
  \item[Case 10: E:Nil]
  Similar to E:Const*
  \item[Case 11: E:Cons]
  \begin{align*}
  &V,H,R,F \; \vdash e \Downarrow l,H'',F' \tag{case}\\
  &\text{Suppose } H \vDash V : \Gamma, dom(V) = FV(e), \na{V,H}, \dist{\{R,F,locs_{V,H}(e)\}}\\
  &\text{NTS (1) - (3) holds after evaluation }\\
  &\emph{(1)} \quad \ms{set}(reach_{H''}(l))\\
  &\stable{\{locs_{V,H}(e)\},H,H''} \tag{$\dist{\{F,locs_{V,H}(e)\}}$ and $copy$ only updates $l \in L \subseteq F$}\\
  &reach_H(V(x_i)) = reach_{H''}(V(x_i)) \tag{$reach_H(V(x_i)) \subseteq locs_{V,H}(e)$ and $~\ref{itm:stable}$ for $i = 1,2$}\\
  &reach_{H''}(l) = \{l\} \cup reach_{H''}(V(x_1))\cup reach_{H''}(V(x_2)) \tag{def of $reach_H$}\\
  &\set{reach_{H''}(l)} \tag{$l \notin locs_{V,H}(e)$ and $\na{V,H}$}\\ 
  &\emph{(2)} \quad \dist{\{R,F',reach_{H''}(l)\}}\\
  &R \cap F' = \emptyset \tag{$F' \subseteq F$ and $\dist{\{R,F\}}$}\\
  &R \cap reach_{H''}(l) = \emptyset \tag{$l \in F$ and $\dist{\{R,locs_{V,H}(e)\}}$}\\
  &F' \cap reach_{H''}(l) = \emptyset\tag{$F' \subseteq F$ and $\dist{\{F,locs_{V,H}(e)\}}$}\\
  &\text{Thus we have }\emph{(2)} \quad \dist{\{R,F',reach_{H''}(l)\}}\\
  &\emph{(3)} \quad \stable{R,H,H''} \tag{since copy only updates $l \in L \subseteq F$ and $F \cap R = \emptyset$}\\
  \end{align*}
  \item[Case 12: E:MatNil]
  \begin{align*}
  &\text{Suppose } H \vDash V : \Gamma, dom(V) = FV(e), \na{V,H}, \dist{\{R,F,locs_{V,H}(e)\}}\\
  &\Sigma; \Gamma' \vdash e_1 : B \tag{ad.}\\
  &V,H,R,F \cup g \; \vdash e_1 \Downarrow v, H',F' \tag{ad.}\\
  &H \vDash V' : \Gamma' \tag{def of W.D.E}\\
  &\text{By IH, we have invariant on } J_1\\
  &\text{NTS (1) - (3) to instantiate invariant on } J_1\\
  &\emph{(1)}\quad dom(V') = FV(e_1) \tag{def of $V'$}\\
  &\emph{(2)}\quad \na{V',H} \tag{$\na{V,H}$ and $V' \subseteq V$}\\
  &\emph{(3)}\quad \dist{\{R,F,locs_{V',H}(e_1)\}} \tag{$\dist{\{R,F,locs_{V,H}(e)\}}$ and $locs_{V',H}(e_1) \subseteq locs_{V,H}(e)$}\\
  &\text{Instantiating invariant on } J_1,\\
  &\emph{(1)}\quad \ms{set}(reach_{H'}(v))\\
  &\emph{(2)}\quad \dist{\{R,F_1,reach_{H'}(v)\}}\\
  &\emph{(3)}\quad \stable{R,H,H'}
  \end{align*}
  \item [Case 13: E:MatCons]
  \begin{align*}
  &V(x) = l \tag{ad.}\\
  &H(l) = \pairexcst{v_h}{v_t} \tag{ad.}\\
  &\Gamma = \Gamma', x : L(A) \tag{ad.}\\
  &\Sigma; \Gamma', x_h : A, x_t : L(A) \vdash e_2 : B \tag{ad.}\\
  &V'',H,R,F \cup g \; \vdash e_2 \Downarrow v_2, H_2, F' \tag{ad.} \\
  &\text{Suppose } H \vDash V : \Gamma, dom(V) = FV(e), \na{V,H},\dist{\{F,R,locs_{V,H}(e)\}}\\
  &H \vDash V(x) : L(A) \tag{def of W.D.E}\\
  &H''\vDash v_h : A,\; H'' \vDash v_t : L(A) \tag{ad.}\\
  &H\vDash v_h : A,\; H \vDash v_t : L(A) \tag{???}\\
  &H \vDash V'' : \Gamma', x_h : A, x_t : L(A) \tag{def of W.D.E}\\
  &\text{By IH, we have invariant on } J_1\\
  &\text{NTS (1) - (3) to instantiate invariant on } J_1\\
  &\emph{(1)}\quad dom(V'') = FV(e_2) \tag{def of $V''$}\\
  &\emph{(2)}\quad \na{V'',H} \\
  &\text{Let } x_1, x_2 \in V'', x_1 \ne x_2, r_{x_1} = reach_H(V''(x_1)), r_{x_2} = reach_H(V''(x_2))\\
  & \textbf{case: } x_1 \notin \{x_h,x_t\}, x_2 \notin \{x_h,x_t\}\\
  &\quad (1), (2) \text{ from } \na{V,H}\\
  & \textbf{case: } x_1 = x_h, x_2 \notin \{x_h,x_t\}\\
  &\quad \ms{set}(r_{x_1}) \tag{ since $\ms{set}(reach_H(V(x)))$ from  $\na{V,H}$}\\
  &\quad \ms{set}(r_{x_2}) \tag{since  $\na{V,H}$}\\
  &\quad x_2 \in FV(e) \tag{def of $FV$}\\
  &\quad reach_H(V(x)) \cap r_{x_2} = \emptyset \tag{def of $reach$ and $\na{V,H}$}\\
  &\quad \text{hence } r_{x_1} \cap r_{x_2} = \emptyset\\
  &\textbf{case: } x_1 = x_h, x_2 = x_t\\
  &\quad \ms{set}(r_{x_1}) \text{ since } \ms{set}(reach_{H}(V(x))) \text{ from } \na{V,H}\\
  &\quad \ms{set}(r_{x_2}) \text{ since } \ms{set}(reach_H(V(x))) \text{ from } \na{V,H}\\
  &\quad r_{x_1} \cap r_{x_2} = \emptyset \tag{$\ms{set}(reach_H(V(x))$}\\
  & \textbf{case: otherwise} \\
  &\quad \text{similar to the above}\\
  &\text{Thus we have } \na{V'',H}\\
  &\emph{(3)}\quad \dist{\{R,F \cup g,locs_{V'',H}(e_2)\}}\\
  &(F \cup g) \cap R = \emptyset \tag{ since $F \cap R = \emptyset$ and by def of $g$}\\
  &\text{NTS } R \cap locs_{V'',H}(e_2) = \emptyset\\
  &\text{Let } l' \in locs_{V'',H}(e_2) \text{ be arb.}\\
  &\textbf{case: }  l' \in reach_{H}(V''(x')) \text{ for some $x' \in FV(e_2)$ where } x' \notin \{x_h,x_t\}\\
  &\quad x' \in V \tag{def of $V''$}\\
  &\quad l' \in reach_{H}(V(x'))\\
  &\quad x' \in FV(e) \tag{def of $FV$}\\
  &\quad l' \in locs_{V,H}(e) \tag{def of $locs_{V,H}$}\\
  &\quad l' \notin R \tag{$\dist{\{R,F,locs_{V,H}(e)\}}$}\\
  &\textbf{case: }  l' \in reach_{H}(V''(x_h)) \\tom
  &\quad l' \in reach_{H}(v_h)\\
  &\quad l' \in reach_{H}(V(x)) \tag{def of $reach$}\\
  &\quad l' \in locs_{V,H}(e) \tag{def of $locs_{V,H}$}\\
  &\quad l' \notin R \tag{since $\dist{\{F,R,locs_{V,H}(e)\}}$}\\
  &\textbf{case: }  l' \in reach_{H}(V''(x_t)) \\
  &\quad \text{similar to above}\\
  &\text{Hence } R \cap locs_{V'',H}(e_2) = \emptyset\\
  &F \cap locs_{V'',H}(e_2) = \emptyset \tag{Similar to above}\\
  &g \cap locs_{V'',H}(e_2) = \emptyset \tag{def. of $g$}\\
  &(F \cup g) \cap locs_{V'',H}(e_2) = \emptyset\\
  &\text{Thus } \dist{\{R,F \cup g,locs_{V'',H}(e_2)\}}\\
  &\text{Instantiating invariant on } J_1,\\
  &\emph{(1)} \quad \ms{set}(reach_{H'}(v))\\
  &\emph{(2)} \quad\dist{\{R,F',reach_{H'}(v)\}}\\
  &\emph{(3)} \quad\stable{R,H,H'}\\
  \end{align*}
  \item [Case 13: E:Drop]
  \begin{align*}
  &e = \irl{drop}(x;e') \tag{case}\\
  &V',H,R,F \cup g \vdash e' \Downarrow v,H',F' (\mathcal{J}_1) \tag{ad.}\\
  &\Gamma = \Gamma',x:A \tag{case}\\
  &\Sigma;\Gamma' \sststile{q'}{q} e' : B\\
  &\text{Suppose } dom(V) = FV(e), \na{V,H},\dist{\{R,F,locs_{V,H}(e)\}}\\
  &\text{By IH, we have invariant on } \mathcal{J}_1\\
  &\text{NTS (1) - (3) for } \mathcal{J}_1\\
  &\emph{(1)} \quad dom(V') = FV(e') \tag{$dom(V) = FV(e)$ and def of $FV$}\\
  &\emph{(2)} \quad \na{V',H} \tag{$\na{V,H}$ and $V' \subseteq V$}\\
  &\emph{(3)} \quad \dist{\{R,F \cup g,locs_{V',H}(e')\}}\\
  &g = reach_H(v') \tag{case}\\
  &g \subseteq locs_{V,H}(e) \tag{def of $locs_{V,H}$}\\
  &R \cap (F \cup g) = \emptyset \tag{$\dist{\{R,F\}}$ and $\dist{\{R,locs_{V,H}(e)\}}$}\\
  &R \cap locs_{V',H}(e') = \emptyset \tag{\dist{\{R,locs_{V,H}(e)\}}$ and $locs_{V',H}(e) \subseteq locs_{V,H}(e)$}\\
  &F \cap locs_{V',H}(e') = \emptyset \tag{\dist{\{F,locs_{V,H}(e)\}}$ and $locs_{V',H}(e) \subseteq locs_{V,H}(e)$}\\
  &g \cap locs_{V',H}(e') = \emptyset \tag{$\na{V,H}$}\\
  &\text{Instantiating invariant on }  \mathcal{J}_1,\\
  &\emph{(1)} \quad \set{reach_{H'}(v)}\\
  &\emph{(2)} \quad \disjoint{\{R,F',reach_{H'}(v)\}}\\
  &\emph{(3)} \quad \stable{R,H,H'}\\
  \end{align*}
  \item [Case 13: E:Share]
  \begin{align*}
  &e = \shareabt{x}{x_1}{x_2}{e} \tag{case}\\
  \end{align*}
  \end{description}
\end{proof}

\begin{theorem}[Soundness]
\label{b} let $H \vDash V : \Gamma$, $\Sigma; \Gamma \sststile{q'}{q} e : B$,
and $V,H \; \vdash e \Downarrow v, H'$. Then $\forall C \in \mathbb{Q}^{+}$ and $\forall F,R \subseteq \ms{Loc}$, if we have the following (existence lemma):
\begin{enumerate} 
\item $dom(V) = FV(e)$
\item $\na{V,H}$
\item $\dist{\{R,F,locs_{V,H}(e)\}}$, and
\item $|F| \ge \Phi_{V,H}(\Gamma) + q + C$ 
\end{enumerate}
then there exists $F' \subseteq \ms{Loc}$ s.t.
\begin{enumerate}
  \item $V,H,R,F \vdash e \Downarrow v, H', F'$
  \item $|F'| \ge \Phi_{H'}(v:B) + q' + C$
\end{enumerate}
\end{theorem}

\begin{proof}
Nested induction on the evaluation judgement and the typing judgement.\\
\begin{description}
  \item[Case 1: E:Var]
  \begin{align}
  &V,H,R,F \; \vdash x \Downarrow V(x),H,F \tag{admissibility}\\
  &\Sigma; x : B \sststile{q}{q} x : B \tag{admissibility}\\
  &|F| - |F'|\\
  &\quad = |F| - |F| \tag{ad.}\\
  &\quad = 0\\
  &\Phi_{V,H}(\Gamma) + q - (\Phi_{H'}(v:B) + q')\\
  &\quad = \Phi_{V,H}(x : B) + q - (\Phi_{H}(V(x) : B) + q) \tag{ad.}\\
  &\quad = \Phi_{H}(V(x) : B) + q  - (\Phi_{H}(V(x) : B) + q) \tag{def. of $\Phi_{V,H}$}\\
  &\quad = 0\\
  &|F| - |F'| \le \Phi_{V,H}(\Gamma) +q - (\Phi_{H'}(v:B) + q') \tag{(3),(5)}
  \end{align}
  \item[Case 2: E:Const*]
  Due to similarity, we show only for E:ConstI
  \begin{align*}
  &|F| - |F'| = |F| - |F| \tag{ad.}\\
  &\quad = 0\\
  &\Phi_{V,H}(\Gamma) +q - (\Phi_{H'}(v:B) + q') = \Phi_{V,H}(\emptyset) +q - (\Phi_{H}(v:int) + q) \tag{ad.}\\
  &\quad = 0 \tag{def of $\Phi_{V,H}$}\\
  &|F| - |F'| \le \Phi_{V,H}(\Gamma) +q - (\Phi_{H'}(v:B) + q')
  \end{align*}
  \item[Case 4: E:App]
  \item[Case 5: E:CondT]
  \begin{align*}
  &\Gamma = \Gamma', x : \irl{bool} \tag{ad.}\\
  &H \vDash V : \Gamma' \tag{def of W.F.E}\\
  &\Sigma; \Gamma' \sststile{q'}{q} e_t : B \tag{ad.}\\
  &V,H,R,F \cup g\; \vdash e_t \Downarrow v, H',F' \tag{ad.}\\
  &|F \cup g| - |F'| \le \Phi_{V,H}(\Gamma) +q - (\Phi_{H'}(v:B) + q') \tag{IH}\\
  &|F| - |F'| \le \Phi_{V,H}(\Gamma) +q - (\Phi_{H'}(v:B) + q') \\
  \end{align*}
  \item[Case 6: E:CondF] 
  Similar to E:CondT
  \item[Case 7: E:Let]
  \begin{align*}
  &V,H \vdash e \Downarrow v_2,H_2 \tag{case}\\
  &V,H \vdash e_1 \Downarrow v_1,H_1 \tag{ad.}\\
  &\Sigma; \Gamma_1 \sststile{p}{q} e_1 : A \tag{ad.}\\
  &H \vDash V_1 : \Gamma_1 \tag{def of W.D.E}\\
  &\text{Let } C \in \mathbb{Q}^+, F,R \subseteq \ms{Loc} \text{ be arb.}\\
  &\text{Suppose }  dom(V) = FV(e),\na{V,H}, \dist{\{R,F,locs_{V,H}(e)\}}, \text{ and } |F| \ge \Phi_{V,H}(\Gamma) + q + C\\
  &\text{NTF } F' \text{ s.t. }\\
  &\quad 1. V,H,R,F \vdash e \Downarrow v_2, H_2,F' \text{ and }\\ 
  &\quad 2. |F'| \ge \Phi_{H_2}(v_2:B) + q' + C\\
  &\text{Let } R' = R \cup locs_{V,H}(\irl{lam}(x : \tau.e_2))\\
  &\dist{\{R',F,locs_{V,H}(e_1)\}} \tag{Similar to case in Lemma $~\ref{itm:na}$}\\
  &\text{Instantiate IH with } C = C + \Phi_{V_2,H}(\Gamma_2), F = F, R = R', \text{ we get existence lemma on } J_1:\\
  &\text{NTS (1) - (4) to instantiate existence lemma on } J_1\\
  &\emph{(1)} \quad dom(V_1) = FV(e_1)\\
  &\emph{(2)} \quad \na{V_1,H}\\
  &\emph{(3)} \quad \dist{\{R,F,locs_{V,H}(e)\}} \tag{(1) - (3) all verbatim as in Lemma $~\ref{itm:na}$}\\
  &\emph{(4)} \quad |F| \ge \Phi_{V_1,H}(\Gamma_1) + q + C + \Phi_{V,H}(\Gamma_2) \tag{$|F| \ge \Phi_{V,H}(\Gamma) + q + C$ and $\Phi_{V,H}(\Gamma) \ge \Phi_{V_1,H}(\Gamma_1) + \Phi_{V,H}(\Gamma_2)$}\\
  &\text{Instantiating existence lemma on } J_1, \text{ we get }  F'' \text{ s.t. }\\
  &\quad 1. V,H,R',F \vdash e_1 \Downarrow v_1, H_1,F'' \text{ and }\\ 
  &\quad 2. |F''| \ge \Phi_{H_1}(v_1:A) + p + C + \Phi_{V_2,H_1}(\Gamma_2)\\
  &\text{For the second premise: }\\
  &\Sigma; \Gamma_2, x : A \sststile{q'}{p} e_2 : B \tag{ad.}\\
  &H_1 \vDash v_1 : A \text{ and } \tag{Theorem 3.3.4}\\ 
  &H_1 \vDash V : \Gamma_2 \tag{???}\\
  &H_1 \vDash V' : \Gamma_2, x : A \tag{def of $\vDash$}\\
  &V',H_1 \vdash e_2 \Downarrow v_2,H_2 \tag{ad.}\\
  &\text{Let } g = \{l \in H_1 \mid l \notin F_1 \cup R \cup locs_{V',H_1}(e_2)\}\\ 
  &\text{Instantiate IH with } C = C, F = F'' \cup g, R = R, \text{ we get existence lemma on  } J_2:\\
  &\text{NTS (1) - (4) to instantiate existence lemma on } J_1\\
  &\emph{(1)} \quad dom(V_2') = FV(e_2)\\
  &\emph{(2)} \quad \na{V_2',H_1} \\
  &\emph{(3)} \quad \dist{\{R,F'' \cup g,locs_{V_2',H_1}(e_2)\}} \tag{(1) - (3) all verbatim as in Lemma $\ref{itm:na}$}\\
  &\emph{(4)} \quad |F'' \cup g| \ge \Phi_{V_2',H_1}(\Gamma_2,x:A) + p + C\\
  &\quad |F'' \cup g | \ge |F''|\\
  &\quad \quad \ge \Phi_{H_1}(v_1:A) + p + C + \Phi_{V_2,H}(\Gamma_2) \tag{IH}\\ 
  &\quad \quad = \Phi_{H_1}(v_1:A) + p + C + \Phi_{V_2',H_1}(\Gamma_2) \tag{Lemma 4.3.3}\\ 
  &\quad \quad = \Phi_{V_2',H_1}(\Gamma_2,x:A) + p + C \tag{def of $\Phi$}\\
  &\text{Instantiating existence lemma on } J_2, \text{ we get } F^{(3)} \text{ s.t. }\\
  &\quad 1. V_2',H_1,R, F'' \cup g \vdash e_2 \Downarrow v_2,H_2,F^{(3)} \\
  &\quad 2. |F^{(3)}| \ge \Phi_{H_2}(v_2:B) + q' + C\\
  &\text{Take } F' = F^{(3)}\\
  &V,H,R,F \vdash e \Downarrow v_2, H_2,F' \text{ and } \tag{E:Let}\\ 
  &|F'| \ge \Phi_{H_2}(v_2:B) + q' + C \tag{from IH}\\
  \end{align*}
  \item [Case 14: E:Let1]
  \begin{align*}
  &V,H \vdash e \Downarrow v_2,H_2 \tag{case}\\
  &V,H \vdash e_1 \Downarrow v_1,H_1 \tag{ad.}\\
  &\Sigma; \Gamma_1 \sststile{p}{q} e_1 : A \tag{ad.}\\
  &H \vDash V_1 : \Gamma_1 \tag{def of W.D.E}\\
  &\text{Let } C \in \mathbb{Q}^+, F,R \subseteq \ms{Loc} \text{ be arb.}\\
  &\text{Suppose }  dom(V) = FV(e),\na{V,H}, \dist{\{R,F,locs_{V,H}(e)\}}, \text{ and } |F| \ge \Phi_{V,H}(\Gamma) + q + C\\
  &\text{NTF } F' \text{ s.t. }\\
  &\quad 1. V,H,R,F \vdash e \Downarrow v_2, H_2,F' \text{ and }\\ 
  &\quad 2. |F'| \ge \Phi_{H_2}(v_2:B) + q' + C\\
  &\text{Let } R' = R \cup locs_{V,H}(\irl{lam}(x : \tau.e_2))\\
  &\dist{\{R',F,locs_{V,H}(e_1)\}} \tag{Similar to case in Lemma $~\ref{itm:na}$}\\
  &\text{Instantiate IH with } C = C + \Phi_{V_2,H}(\Gamma_2), F = F, R = R', \text{ we get existence lemma on } J_1:\\
  &\text{NTS (1) - (4) to instantiate existence lemma on } J_1\\
  &\emph{(1)} \quad dom(V_1) = FV(e_1)\\
  &\emph{(2)} \quad \na{V_1,H}\\
  &\emph{(3)} \quad \dist{\{R,F,locs_{V,H}(e)\}} \tag{(1) - (3) all verbatim as in Lemma $~\ref{itm:na}$}\\
  &\emph{(4)} \quad |F| \ge \Phi_{V_1,H}(\Gamma_1) + q + C + \Phi_{V,H}(\Gamma_2) \tag{$|F| \ge \Phi_{V,H}(\Gamma) + q + C$ and $\Phi_{V,H}(\Gamma) \ge \Phi_{V_1,H}(\Gamma_1) + \Phi_{V,H}(\Gamma_2)$}\\
  &\text{Instantiating existence lemma on } J_1, \text{ we get }  F'' \text{ s.t. }\\
  &\quad 1. V,H,R',F \vdash e_1 \Downarrow v_1, H_1,F'' \text{ and }\\ 
  &\quad 2. |F''| \ge \Phi_{H_1}(v_1:A) + p + C + \Phi_{V_2,H_1}(\Gamma_2)\\
  &\text{For the second premise: }\\
  &\Sigma; \Gamma_2, x : A \sststile{q'}{\max{(p,q)}} e_2 : B \tag{ad.}\\
  &H_1 \vDash v_1 : A \text{ and } \tag{Theorem 3.3.4}\\ 
  &H_1 \vDash V : \Gamma_2 \tag{???}\\
  &H_1 \vDash V' : \Gamma_2, x : A \tag{def of $\vDash$}\\
  &V',H_1 \vdash e_2 \Downarrow v_2,H_2 \tag{ad.}\\
  &\text{Let } g = \{l \in H_1 \mid l \notin F'' \cup R \cup locs_{V',H_1}(e_2)\}\\ 
  &\text{Instantiate IH with } C = C, F = F'' \cup g, R = R, \text{ we get existence lemma on  } J_2:\\
  &\text{NTS (1) - (4) to instantiate existence lemma on } J_1\\
  &\emph{(1)} \quad dom(V_2') = FV(e_2)\\
  &\emph{(2)} \quad \na{V_2',H_1} \\
  &\emph{(3)} \quad \dist{\{R,F'' \cup g,locs_{V_2',H_1}(e_2)\}} \tag{(1) - (3) all verbatim as in Lemma $~\ref{itm:na}$}\\
  &\emph{(4)} \quad |F'' \cup g| \ge \Phi_{V_2',H_1}(\Gamma_2,x:A) + q + C\\
  &\quad |F'' \cup g | \ge |F''|\\
  &\quad \quad \ge \Phi_{H_1}(v_1:A) + p + C + \Phi_{V_2,H}(\Gamma_2) \tag{IH}\\ 
  &\quad \quad = \Phi_{H_1}(v_1:A) + p + C + \Phi_{V_2',H_1}(\Gamma_2) \tag{Lemma 4.3.3}\\ 
  &\quad \quad = \Phi_{V_2',H_1}(\Gamma_2,x:A) + p + C \tag{def of $\Phi$}\\
  &\text{Instantiating existence lemma on } J_2, \text{ we get } F^{(3)} \text{ s.t. }\\
  &\quad 1. V_2',H_1,R, F'' \cup g \vdash e_2 \Downarrow v_2,H_2,F^{(3)} \\
  &\quad 2. |F^{(3)}| \ge \Phi_{H_2}(v_2:B) + q' + C\\
  &\text{Take } F' = F^{(3)}\\
  &V,H,R,F \vdash e \Downarrow v_2, H_2,F' \text{ and } \tag{E:Let}\\ 
  &|F'| \ge \Phi_{H_2}(v_2:B) + q' + C \tag{from IH}\\
  \end{align*}
  \item[Case 8: E:Pair]
  Similar to E:Const*
  \item[Case 9: E:MatP]
  Similar to E:MatCons
  \item[Case 10: E:Nil]
  Similar to E:Const*
  \item[Case 11: E:Cons]
  \begin{align*}
  &V,H \vdash \consexabt{x_1}{x_2} \Downarrow l, H' \tag{case}\\
  &\text{Let } C \in \mathbb{Q}^+, F,R \subseteq \ms{Loc} \text{ be arb.}\\
  &\text{Suppose } dom(V) = FV(e), \na{V,H}, \dist{\{R,F,locs_{V,H}(e)\}}, |F| \ge \Phi_{V,H}(\Gamma) + q + C\\
  &\text{NTF } F' \text{ s.t. }\\
  &\quad 1. V,H,R,F \vdash e \Downarrow v, H',F' \text{ and }\\ 
  &\quad 2. |F'| \ge \Phi_{H'}(v:B) + q' + C\\
  &\text{Let } F' = F \ 
  \end{align*}
  \item[Case 12: E:MatNil]
  Similar to E:Cond*
  \item[Case 13: E:MatCons]
  \begin{align*}
  &V(x) = (l,\irl{alive}) \tag{ad.}\\
  &H(l) = \pairexcst{v_h}{v_t} \tag{ad.}\\
  &\Gamma = \Gamma', x : L^p(A) \tag{ad.}\\
  &\Sigma; \Gamma', x_h : A, x_t : L^p(A) \sststile{q'}{q + p + 1} e_2 : B \tag{ad.}\\
  &V'',H \; \vdash e_2 \Downarrow v, H' \tag{ad.}\\
  &\text{Let } C \in \mathbb{Q}^+, F,R \subseteq \ms{Loc} \text{ be arb.}\\
  &H \vDash V(x) : L^p(A) \tag{def of W.D.E}\\
  &H''\vDash v_h : A,\; H'' \vDash v_t : L^p(A) \tag{ad.}\\
  &H\vDash v_h : A,\; H \vDash v_t : L^p(A) \tag{???}\\
  &H \vDash V'' : \Gamma', x_h : A, x_t : L^p(A) \tag{def of W.D.E}\\
  &\text{Suppose }  \na{V,H}, \dist{\{R,F,locs_{V,H}(e)\}}, \text{ and } |F| \ge \Phi_{V,H}(\Gamma) + q + C\\
  &\text{NTF } F' \text{ s.t. }\\
  &\quad 1. V,H,R,F \vdash e \Downarrow v, H',F' \text{ and }\\ 
  &\quad 2. |F'| \ge \Phi_{H'}(v:B) + q' + C\\
  &\text{Let } g = \{l \in H \mid l \notin F \cup R \cup locs_{V'',H}(e_2)\}\\
  &\text{We want to $g$ nonempty, in particular, that } l \in g\\
  &\quad l \notin F \cup R \tag{$\dist{\{R,F,locs_{V,H}(e)\}}$}\\
  &\quad \text{AFSOC } l \in locs_{V'',H}(e_2)\\
  &\quad \text{Then } l \in reach_H(\overline V'' (x')) \text{ for some } x' \ne x\\
  &\quad x' \in \{x_h,x_t\} \tag{since $reach_H(\overline V (x')) \cap reach_H(\overline (Vx)) = \emptyset$ from $\na{V,H}$}\\
  &\quad \text{WLOG let } x' = x_h\\
  &\quad \text{But then } \mu_{reach_H(\overline V(x))}(l) \ge 2 \text{ and } \ms{set}(reach_(\overline V(x))) \text{ doesn't hold}\\
  &\quad l \notin locs_{V'',H}(e_2)\\
  &\text{Hence } l \in g\\
	&\text{Next, we have } \na{V'',H} \text{ and } \dist{\{R,F \cup g,locs_{V'',H}(e_2)\}} \tag{similar to case in Lemma 1.2}\\
	&\text{By IH with } C' = C, F'' = F \cup g \text{ and the above conditions, we have: } F^{(3)} \text{ s.t.}\\
	&\quad 1. V'',H,R,F\cup g \vdash e_2 \Downarrow v,H',F^{(3)}\\
	&\quad 2. |F^{(3)}| \ge \Phi_{H'}(v:B) + q' + C\\
	&\text{Where we also verify the precondition that } |F''| \ge \Phi_{V'',H}(\Gamma',x_h:A,x_t:L^p(A)) + q + p + 1 + C':\\
	&\quad |F''| = |F \cup g|\\
	&\quad \quad = |F| + |g| \tag{$F$ and $g$ disjoint}\\
	&\quad \quad \ge \Phi_{V,H}(\Gamma) + q + C + |g| \tag{Sp.}\\
	&\quad \quad = \Phi_{V,H}(\Gamma',x_h:A,x_t:L^p(A)) + p + q + C + |g| \tag{Lemma 4.1.1}\\
	&\quad \quad = \Phi_{V,H}(\Gamma',x_h:A,x_t:L^p(A)) + p + q + C + 1 \tag{$g$ nonempty}\\
	&\text{Now take } F' = F^{(3)}\\
	&V,H,R,F \; \vdash e \Downarrow v,H',F' \tag{E:MatCons}\\
  &|F'| \ge \Phi_{H'}(v:B) + q' + C \tag{From the IH}\\
  \end{align*}
  \end{description}
\end{proof}


\end{document}
